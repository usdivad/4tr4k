<html>
	<!--f2013-->
	<head>
<link href='2_style.css' rel='stylesheet' type='text/css'>
		<div id="header">
		<b>An Invincible Determination Can Accomplish Almost Anything...</b> <a href="http://usdivad.com/">~thomas fuller</a>
		<!--<br><font size="2.5px">Best viewed in Chrome at 125%</font>-->
		<br><br>
		
	</div>
	<style>
		#snapshots_box {
			display:none;
			float:bottom;
		}
		#playback_box {
			float:none;
		}
		#sections_box, #seed_box {
			padding-bottom:50px;
			padding-left:50px;
		}
		body {
			background: white;
		}

		input[type=radio] {
			margin-right: 10px;
			margin-left: 25px;
		}
	</style>
	</head>

	<body>
		<div id="playback_box">
		<b>PLAYBACK</b>
		<br>
		<input type="button" id="play" value="play">
		<input type="button" id="pause" value="pause">
		</div>
		<div id="snapshots_box">
			<b>SNAPSHOTS</b>
			<br>
			<input type="button" id="snapshot1_save" value="Save 1">
			<input type="button" id="snapshot1_set" value="Set 1">
			<br>
			<input type="button" id="snapshot2_save" value="Save 2">
			<input type="button" id="snapshot2_set" value="Set 2">
			<br>
			<input type="button" id="snapshot3_save" value="Save 3">
			<input type="button" id="snapshot3_set" value="Set 3">

		</div>
		<div id="seed_box">
			{<br><b>Choose your melodic seed</b><br>
			<input type="radio" id="seed_parker" name="seed" value='Charlie Parker - "Confirmation"' checked><label for="seed_parker">Charlie Parker - "Confirmation"</label><br>
			<input type="radio" id="seed_bach" name="seed" value='J.S. Bach - "Canon a 2 cancrizans" (from the Musical Offering)'><label for="seed_bach">J.S. Bach - "Canon a 2 cancrizans" (from the Musical Offering)</label><br>}
		</div>
		<div id="sections_box">
			<b>...and in this lies the great distinction between great men and little men.<br></b>
			<input type="radio" id="generate1" name="gen_type" value="Generate little man"><label for="generate1">Generate little man</label> 
			<input type="radio" id="generate2" name="gen_type" value="Generate middleman"><label for="generate2">Generate middleman</label> 
			<input type="radio" id="generate3" name="gen_type" value="Generate great man"><label for="generate3">Generate great man</label>

		</div>
		<div id="preset_box">
			<b>PRESETS</b><br>
			<input type="button" id="preset_giveDrummer" value="Give the Drummer Some">
			<input type="button" id="preset_randomScales" value="Rand(iatonic)om">
			<input type="button" id="preset_gp0" value="Glass Pagoda p0">
			<input type="button" id="preset_gp1" value="Glass Pagoda p1">
			<input type="button" id="preset_gp2" value="Glass Pagoda p2">
			<input type="button" id="preset_roar" value="Roar, Lion, Roar!">
			<br><br>
		</div>
		<div id="r_box">
		<b>RHYTHM</b><br>
		H(IGH): <span style="color:white">[q]</span> <input type="text" id="hat_text" value="0"><br><br>
		S(MED): <span style="color:white">[w]</span> <input type="text" id="snare_text" value="0"><br><br>
		K(LOW): <span style="color:white">[e]</span> <input type="text" id="kick_text" value="0"><br><br>
		N(OIS): <span style="color:white">[r]</span> <input type="text" id="noise_text" value="0"><br>
		<!--<input type="button" id="update" value="update">-->
		</div>
		<!--<br><Br>-->
		<div id="p_box">
			<form id="scoobydoo">
		<b>PITCH</b><br>
		H_SEQ: 
		<span style="color:white">[a]</span>
		<input type="text" id="h_seq_text" value="A3" onclick="$('#h_select').attr('checked', 'checked');">
		<input type="button" id="h_octDown" value="- 8ve">
		<input type="button" id="h_octUp" value="+ 8ve">
		<input type="radio" name="select" id="h_select" value="h" checked="checked">
		<br><br>
		
		S_SEQ: 
		<span style="color:white">[s]</span>
		<input type="text" id="s_seq_text" value="A2" onclick="$('#s_select').attr('checked', 'checked');">
		<input type="button" id="s_octDown" value="- 8ve">
		<input type="button" id="s_octUp" value="+ 8ve">
		<input type="radio" name="select" id="s_select" value="s">
		<br><br>

		K_SEQ: 
		<span style="color:white">[d]</span>
		<input type="text" id="k_seq_text" value="A1" onclick="$('#k_select').attr('checked', 'checked');">
		<input type="button" id="k_octDown" value="- 8ve">
		<input type="button" id="k_octUp" value="+ 8ve">
		<input type="radio" name="select" value="k" id="k_select">
		<br><br>


		N_SEQ: 
		<span style="color:white">[f]</span>
		<input type="text" id="n_seq_text" value="A3" onclick="$('#n_select').attr('checked', 'checked');">
		<input type="button" id="n_octDown" value="- 8ve">
		<input type="button" id="n_octUp" value="+ 8ve">
		<input type="radio" name="select" value="n" id="n_select">
	</form>
		</div>
		<div id="display_boxes">
			<div id="h_box"></div><br>
			<div id="s_box"></div><br>
			<div id="k_box"></div><br>
			<div id="n_box"></div><br>
		</div>
		<br><br><br><br><br><br>
		<div id="glob_box"><br>
		<b>GLOB</b><br>
		BPM16: <input type="text" id="bpm_text" value="90"><br>
		:)<br>
		<!--<input type="button" id="bang" value="bang">-->
		</div>


<!-- onclicks = badoop, oh well loo loo-->
<!-- the spans are the black notes BEFORE the div anchors-->
		

		<script src="lib/timbre.js"></script>
		<script src="lib/jquery.js"></script>
		<script src="src/display.js"></script>
		<script src="src/geo.js"></script>
		<script src="src/audio_functions.js"></script>
		<script src="src/audio_base.js"></script>
		<script src="src/audio_timer.js"></script>
		<script src="src/input.js"></script>
		<script src="src/compositions.js"></script>

<script>
	//MARKOV!
	//Charlie Parker - "Confirmation" (Verve 8005, Omnibook p1)
	var melody_parker = "A2 C3 A2 Bb2 A2 E2 F2 Gb2 G2 D3 Bb2 G2 A2 Db2 G2 F2 A2 G2 Bb2 A2 G2 F2 Bb2 B2 Bb2 Ab2 F2 Bb2 Ab2 C3 Bb2 G2 Gb2 A2 D2 D3 E3 A2 Eb3 D3 Db3 F2 G2 E2 C3 A2 F2 Bb2 A2 Ab2 G2 A2 F2 G2 Eb2 Db2 G2 F2 A2 G2 Bb2 A2 G2 F2 Db2 F2 F2 Ab2 Bb2 F2 Ab2 Bb2 Eb2 G2 Bb2 A2 Gb2 G2 Bb2 A2 Bb2 A2 G2 C3 Ab2 A2 F2 D3 C3 G2 Eb2 C2 B2 G2 G2 Bb2 C3 Bb2 G2 Eb2 Ab2 Gb2 B1 F2 A2 F2 A2 G2 G2 Bb2 Db3 Bb2 Ab2 A2 C3 Bb2 Gb2 Ab2 F2 E2 Eb2 Ab2 Ab2 Ab2 Ab2 Gb2 E2 F2 Ab2 C3 Eb3 D3 C3 Db3 Bb2 G2 Db2 F2 Ab2 E2 D2 C2 C3 Bb2 A2 E2 F2 Gb2 G2 D3 Bb2 G2 A2 Db2 G2 F2 A2 G2 Bb2 A2 G2 F2 Bb2 B2 Bb2 Ab2 F2 Bb2 Ab2 C3 Bb2 Ab2 A2 Db2 D2 F2 D2 F2 A2 F2 D2 F2 B1 E2 G2";

	//J.S. Bach - "Canon a 2 cancrizans (from the Musical Offering)" (BWV 1079)
	//var melody_bach = "Eb2 C2 Eb2 G2 Ab2 G2 F2 G2 Eb2 Eb2 D2 C2 C3 Bb2 G2 Ab2 F2 F2 Eb2 F2 D2 C2 Eb2 F2 Ab2 Bb2 G2 Bb2 C3 F3 G2 Ab2 Bb2 Eb2 F2 Ab2 Bb2 C3 G2 Eb2 C2 Eb2 Bb2 C3 C3 D3 D3 G2 Eb2 F3 D3 D3 Ab3 Eb3 C3 C3 Eb3 Eb3 G2 Ab2 D2 G2 F2 F2 G2 G2 Bb2 G2 F3 F3 C2 F2 F2 F2 G2 C3 C3 Eb3 Bb2 G2 D2";
	var melody_bach = "C2 Eb2 G2 Ab2 B1 G2 Gb2 F2 E2 Eb2 D2 Db2 C2 B1 G1 C2 F2 Eb2 D2 C2 Eb2 G2 F2 G2 C3 G2 Eb2 D2 Eb2 F2 G2 A2 B2 C3 Eb2 F2 G2 Ab2 D2 Eb2 F2 G2 F2 Eb2 D2 Eb2 F2 G2 Ab2 Bb2 Ab2 G2 F2 G2 Ab2 Bb2 C3 Db3 Bb2 Ab2 G2 A2 B2 C3 D3 Eb3 C3 B2 A2 B2 C3 D3 Eb3 F3 D3 G2 D3 C3 D3 Eb3 F3 Eb3 D3 C3 B2 C3 G2 Eb2 C2";
	var rhythm_bach = [1000,1000,1000,1000,1000,00,1000,1000,1000,1000,1000,10,10,10,10,10,10,10,1000,1000,1000,1000];
	for (var i=0;i<8*8;i++) {
		rhythm_bach.push(1);
	}
	rhythm_bach.push(10,10,10,10);


	//Original Invincible Theme
	//seed_arr = ["Bb2", "Bb2", "Ab2", "Gb2", "Gb2", "F2", "E2", "E2", "Db2", "C2", "Bb2", "Bb2", "Ab2", "Ab2", "Gb2", "Bb1", "Bb2", "C3", "C3", "c3", "eb3", "F3", "F3", "Db3", "c3", 'db3', 'db3', 'd3', 'd3', 'c3', 'bb2', 'bb2'];

	var seed_arr = [];
	var pitches = {};
	
	//default = parker
	markov_setup(melody_parker);

	function markov_setup(seed_pitch) {
		seed_arr = seed_pitch.split(" ");

		//Setup the chain via associative arrays (this way we don't have to manually calculate probabilities)
		for (var i=0; i<seed_arr.length; i++) {
			var pitch = seed_arr[i];
			var following = seed_arr[0];
			if (i < seed_arr.length-1) {
				following = seed_arr[i+1];
			}
			if (!pitches.hasOwnProperty(pitch)) {
				pitches[pitch] = [];
			}
			pitches[pitch].push(following);
		}
	}

	$("#seed_parker, #seed_bach").click(function() {
		$("input[name=gen_type]").prop("checked", false);
	});
	$("#seed_parker").click(function() {
		markov_setup(melody_parker);
	});
	$("#seed_bach").click(function() {
		markov_setup(melody_bach);
	});

	//Construct a melody
	function markov_melody(size) {
		var start = dice_pick(seed_arr);
		var melody = [start];

		for (var i=1; i<size; i++) {
			var prev = melody[i-1];
			var choices = pitches[prev];
			var next = dice_pick(choices);
			if (next >= 0) {
				melody.push(next);
			}
			else { //happens if sample size is too small
				melody.push(dice_pick(seed_arr));
			}
		}

		return melody.join(" ");
	}

	function dice_pick(arr) {
		var idx = Math.floor(Math.random()*arr.length);
		return arr[idx];
	}

	//Output probability table as a string
	function calculateProbabilities(firstPitch) {
	    var arr = pitches[firstPitch];
	    var counts = {};

	    for (var i=0; i<arr.length; i++) {
	        var element = arr[i];
	        if (counts.hasOwnProperty(element)) {
	            counts[element] += 1;
	        }
	        else {
	            counts[element] = 1;
	        }
	    }

	    //output string
	    var out = "Pitch: Probability of following " + firstPitch + "\n";

	    for (var k in counts) {
	        counts[k] = ((counts[k]/arr.length)*100).toFixed(2) + "%";
	        out += k + ": " + counts[k] + "\n";
	    }

	    return out;
	}

	//Genearate
	function generate_man(type) {
		var r_lead = random_rhythm();
		var r_comp = random_rhythm();
		var r_drums = random_rhythm(); //Haiku below:
		var p_lead = markov_melody(123); //counting ascension
		var p_comp = markov_melody(12); //a disappearing number
		var p_drums = markov_melody(42); //universal truth

		//Create custom tonal bassline
		p_comp_choices = ["F2", "A2", "C3", "Eb3", "G2", "D3"];
		p_comp_arr = ["F2"];
		p_comp_length = 24;
		for (var i=0; i<p_comp_length; i++) {
			p_comp_arr.push(dice_pick(p_comp_choices));
		}
		p_comp = p_comp_arr.join(" ");

		//altering r_comp for arrangement (next iteration!)
		//[code]

		//Using randomly generated rhythms
		//set_tracks(r_lead, r_comp, r_comp, r_drums, p_lead, p_comp, p_comp, p_drums, 208);
		
		//Using hard-coded rhythms (more idiomatic)

		switch (type) {
			case 1:
				//v1: jazz style
				set_tracks("1XX", "X00", "10X", r_drums, p_lead, p_comp, p_comp, p_drums, 104*1.5);
				for (var i=0; i<2; i++) {
					$("#n_octUp").trigger("click");
				}
				break;

			case 2:
				//v2: atonal fugue like
				set_tracks("X0X", "0", "10X", "10X", p_lead, "[tacet]", p_lead, p_lead, 104*1.5);
				break;

			case 3:
				//v3: even weirder canon
				//set_tracks("1", "0", "1", 0, p_lead, "[tacet]", "F3 F3 F3 F3 "+p_lead, "[tacet]", 104);
				
				new_rhythms = generate_rhythms(rhythm_bach);
				new_pitch = to_legato(p_lead, new_rhythms);
				//set_tracks(new_rhythms, "0", new_rhythms.split("").reverse().join(""), "0", p_lead, "[tacet]", p_lead.split(" ").reverse().join(" "), "[tacet]", 104);
				set_tracks("1", "0", "1", "0", new_pitch, "[tacet]", new_pitch.split(" ").reverse().join(" "), "[tacet]", 104);
				console.log("rhythm: " + new_rhythms + "\n" + "pitch (original): " + p_lead);
				break;
		}

		//use dice to pick rhythms out of an array
		function generate_rhythms(arr) {
			var new_rhythms = [];
			var max = p_lead.split(" ").length;
			for (var i=0; i<max; i++) {
				new_rhythms.push(dice_pick(arr));
			}
			return new_rhythms.join("");
		}

		//returns a pitch string that is the legato version of whatever sequence is given; to use the pitch string change rhythm to "1"
		function to_legato(pitch, rhythm) {
			var pitch_arr = pitch.split(" ");
			var rhythm_arr = rhythm.split("");
			var new_pitch_arr = [];
			//new_rhythm_arr = [];

			var pitch_index = 0;
			for (var i=0; i<rhythm_arr.length; i++) {
				new_pitch_arr.push(pitch_arr[pitch_index]);
				if (rhythm_arr[i] == 1) { 
					pitch_index++;
				}
			}

			return new_pitch_arr.join(" ");
		}

		//OK put all three together!!
		
		//Octave shifting (old stupid way)
		if (type == 3) {
			$("#h_octUp").trigger("click");
		}
		else {
			$("#k_octDown").trigger("click");
			for (var i=0; i<2; i++) {
				$("#h_octUp").trigger("click");
			}
			for (var i=0; i<3; i++) {
				$("#n_octUp").trigger("click");
			}
		}
	}

	//User click
	$("#generate1").click(function(){generate_man(3);});
	$("#generate2").click(function(){generate_man(2);});
	$("#generate3").click(function(){generate_man(1);});

</script>
	
<!-- google analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42212505-1', 'usdivad.com');
  ga('send', 'pageview');

</script>
	</body>
</html>
